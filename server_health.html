{% extends "base.html" %}

{% block title %}Windows Server Health - Northern PowerGrid{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center mb-4 p-3 bg-body-secondary rounded-3 gap-2">
    <h2 class="h4 mb-0">{{ team_name }} Team - Server Health Report</h2>
    <div class="d-flex gap-2">
        <a href="{{ url_for('windows.dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i>
            Back
        </a>
        <button class="btn btn-outline-secondary" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i>
            Refresh
        </button>
        <a href="{{ url_for('windows.export_report') }}" class="btn btn-danger">
            <i class="fas fa-file-excel"></i> Export Report
        </a>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col">
        <div class="card clickable-card shadow-sm h-100" onclick="filterTableAndScroll('all')" data-filter="all">
            <div class="card-body d-flex align-items-center">
                <div class="p-3 rounded-circle bg-primary-subtle text-primary me-3"><i class="fas fa-server fs-5"></i></div>
                <div>
                    <div class="fs-4 fw-bold">{{ servers|length }}</div>
                    <div class="text-muted">Total Servers</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card clickable-card shadow-sm h-100" onclick="filterTableAndScroll('critical')" data-filter="critical">
            <div class="card-body d-flex align-items-center">
                <div class="p-3 rounded-circle bg-danger-subtle text-danger me-3"><i class="fas fa-times-circle fs-5"></i></div>
                <div>
                    <div class="fs-4 fw-bold">{% set critical_count = servers|selectattr('Status', 'ne', 1)|list|length %}{{ critical_count }}</div>
                    <div class="text-muted">Offline/Critical</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card clickable-card shadow-sm h-100" onclick="filterTableAndScroll('high_cpu')" data-filter="high_cpu">
            <div class="card-body d-flex align-items-center">
                <div class="p-3 rounded-circle bg-warning-subtle text-warning me-3"><i class="fas fa-microchip fs-5"></i></div>
                <div>
                    <div class="fs-4 fw-bold">{% set high_cpu = servers|selectattr('CPULoad', 'gt', 50)|list|length %}{{ high_cpu }}</div>
                    <div class="text-muted">High CPU</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card clickable-card shadow-sm h-100" onclick="filterTableAndScroll('high_memory')" data-filter="high_memory">
            <div class="card-body d-flex align-items-center">
                <div class="p-3 rounded-circle bg-warning-subtle text-warning me-3"><i class="fas fa-memory fs-5"></i></div>
                <div>
                    <div class="fs-4 fw-bold">{% set high_memory = servers|selectattr('MemoryUsagePercent', 'gt', 80)|list|length %}{{ high_memory }}</div>
                    <div class="text-muted">High Memory</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card clickable-card shadow-sm h-100" onclick="filterTableAndScroll('high_disk')" data-filter="high_disk">
            <div class="card-body d-flex align-items-center">
                <div class="p-3 rounded-circle bg-info-subtle text-info me-3"><i class="fas fa-hdd fs-5"></i></div>
                <div>
                    <div class="fs-4 fw-bold">{% set high_disk = servers|selectattr('MaxDiskUsage', 'gt', 70)|list|length %}{{ high_disk }}</div>
                    <div class="text-muted">High Disk</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body d-flex flex-wrap gap-3 align-items-center">
        <div class="flex-grow-1">
            <input type="text" id="table-search" class="form-control" placeholder="Search servers by name, IP, OS..." oninput="searchTable()">
        </div>
        <div class="d-flex gap-3">
            <select id="table-filter" class="form-select" onchange="applyTableFilter()" style="min-width: 200px;">
                <option value="all" selected>Filter by issue...</option>
                <option value="critical">Offline/Critical</option>
                <option value="high_cpu">High CPU (>50%)</option>
                <option value="high_memory">High Memory (>80%)</option>
                <option value="high_disk">High Disk (>70%)</option>
            </select>
            <button onclick="clearFilters()" class="btn btn-secondary">Clear</button>
        </div>
    </div>
</div>

{% set critical_servers = servers|selectattr('Status', 'ne', 1)|list %}
{% set memory_critical = servers|selectattr('MemoryUsagePercent', 'gt', 95)|list %}
{% set total_critical_count = critical_servers|length + memory_critical|length %}

{% if total_critical_count > 0 %}
<div class="alert alert-danger" role="alert">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h4 class="alert-heading mb-1"><i class="fas fa-exclamation-triangle"></i> CRITICAL ISSUES - Immediate Action Required</h4>
            <p class="mb-0">
                Found <strong>{{ total_critical_count }} critical issue(s)</strong> that require immediate attention.
            </p>
        </div>
        <a class="btn btn-outline-danger" data-bs-toggle="collapse" href="#criticalIssuesList" role="button" aria-expanded="false" aria-controls="criticalIssuesList">
            View Details
        </a>
    </div>
    <hr>
    <div class="collapse" id="criticalIssuesList">
        <div class="p-2 rounded" style="max-height: 350px; overflow-y: auto; background-color: rgba(0,0,0,0.03);">
            <div class="d-flex flex-column gap-2">
                {% for server in critical_servers %}
                <div class="p-2 border-start border-danger border-4">
                    <strong class="me-2">{{ server.NodeName }}</strong> - <span class="badge text-bg-danger">SERVER DOWN</span> - Server is offline or in critical state (IP: {{ server.IPAddress }})
                </div>
                {% endfor %}
                {% for server in memory_critical %}
                <div class="p-2 border-start border-danger border-4">
                    <strong class="me-2">{{ server.NodeName }}</strong> - <span class="badge text-bg-danger">MEMORY CRITICAL</span> - Memory usage at {{ "%.1f"|format(server.MemoryUsagePercent) }}% (IP: {{ server.IPAddress }})
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="card shadow-sm mb-4">
    <div class="card-header">
        <h3 class="h5 mb-0">Server Resource Hotspot Analysis</h3>
    </div>
    <div class="card-body">
        <div id="health-graph" style="height:500px;"></div>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header">
        <h3 class="h5 mb-0">Health Summary by Operating System</h3>
    </div>
    <div class="card-body">
        <div id="os-summary-graph" style="height:450px;"></div>
    </div>
</div>


<div class="card shadow-sm" id="server-details-section">
    <div class="card-header">
        <h3 class="h5 mb-0">Windows Server Details</h3>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table id="servers-table" class="table table-hover table-striped mb-0">
                <thead class="table-light">
                    <tr>
                        <th onclick="sortTable(0)" class="cursor-pointer">Server Name <i class="fas fa-sort text-muted ms-1"></i></th>
                        <th onclick="sortTable(1)" class="cursor-pointer">Status <i class="fas fa-sort text-muted ms-1"></i></th>
                        <th onclick="sortTable(2)" class="cursor-pointer">Operating System <i class="fas fa-sort text-muted ms-1"></i></th>
                        <th onclick="sortTable(3)" class="cursor-pointer">IP Address <i class="fas fa-sort text-muted ms-1"></i></th>
                        <th onclick="sortTable(4)" class="cursor-pointer">CPU <i class="fas fa-sort text-muted ms-1"></i></th>
                        <th onclick="sortTable(5)" class="cursor-pointer">Memory <i class="fas fa-sort text-muted ms-1"></i></th>
                        <th onclick="sortTable(6)" class="cursor-pointer">Max Disk <i class="fas fa-sort text-muted ms-1"></i></th>
                        <th onclick="sortTable(7)" class="cursor-pointer">Total Memory<i class="fas fa-sort text-muted ms-1"></i></th>
                    </tr>
                </thead>
                <tbody>
                    {% for server in servers %}
                    <tr data-status="{{ server.Status }}"
                        data-cpu="{{ server.CPULoad }}"
                        data-memory="{{ server.MemoryUsagePercent }}"
                        data-disk="{{ server.MaxDiskUsage }}">
                        <td class="fw-bold">{{ server.NodeName }}</td>
                        <td>
                            {% if server.Status == 1 %}
                            <span class="badge text-bg-success">Online</span>
                            {% else %}
                            <span class="badge text-bg-danger">Offline</span>
                            {% endif %}
                        </td>
                        <td>{{ server.OperatingSystem }}</td>
                        <td>{{ server.IPAddress }}</td>
                        <td>
                            <span class="fw-semibold {% if server.CPULoad > 70 %}text-danger{% elif server.CPULoad > 50 %}text-warning{% else %}text-success{% endif %}">
                                {{ server.CPULoad }}%
                            </span>
                        </td>
                        <td>
                             <span class="fw-semibold {% if server.MemoryUsagePercent > 90 %}text-danger{% elif server.MemoryUsagePercent > 80 %}text-warning{% else %}text-success{% endif %}">
                                {{ "%.1f"|format(server.MemoryUsagePercent) }}%
                            </span>
                        </td>
                        <td>
                            <span class="fw-semibold {% if server.MaxDiskUsage > 80 %}text-danger{% elif server.MaxDiskUsage > 70 %}text-warning{% else %}text-success{% endif %}">
                                {{ "%.1f"|format(server.MaxDiskUsage) }}%
                            </span>
                        </td>
                        <td>{{ "%.1f"|format(server.TotalMemorySize) }} GB</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% for server in servers %}
<div class="disk-details-container card shadow-sm mt-4" data-server-name="{{ server.NodeName }}" style="display: none;">
    <div class="card-header">
        <h4 class="h6 mb-0">{{ server.NodeName }} - Disk Usage Details</h4>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table mb-0">
                <thead>
                    <tr>
                        <th>Disk Name</th>
                        <th>Disk Size (GB)</th>
                        <th>Usage</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for disk in server.Disks %}
                    <tr>
                        <td class="font-monospace">{{ disk.DiskName }}</td>
                        <td>{{ "%.1f"|format(disk.DiskSizeGB) }} GB</td>
                        <td>
                            <span class="fw-semibold {% if disk.DiskUsagePercent > 80 %}text-danger{% elif disk.DiskUsagePercent > 70 %}text-warning{% else %}text-success{% endif %}">
                                {{ "%.1f"|format(disk.DiskUsagePercent) }}%
                            </span>
                        </td>
                        <td>
                            {% if disk.DiskUsagePercent > 90 %}
                            <span class="text-danger fw-bold">Critical</span>
                            {% elif disk.DiskUsagePercent > 80 %}
                            <span class="text-warning fw-bold">Warning</span>
                            {% else %}
                            <span class="text-success fw-bold">Normal</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endfor %}

<style>
    .cursor-pointer {
        cursor: pointer;
    }
    html {
        scroll-behavior: smooth;
    }
    .clickable-card {
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .clickable-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    .clickable-card:active {
        transform: translateY(-2px);
    }
</style>

<script>
// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateDiskDetailsVisibility();
});

// Function to filter table and scroll to it
function filterTableAndScroll(filter) {
    // Update the dropdown to match the filter
    const dropdown = document.getElementById('table-filter');
    if (dropdown) {
        dropdown.value = filter;
    }

    // Apply the filter
    applyTableFilter();

    // Scroll to the server details table with offset for better visibility
    setTimeout(function() {
        const serverSection = document.getElementById('server-details-section');
        if (serverSection) {
            const offset = 100;
            const elementPosition = serverSection.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - offset;

            window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
            });
        }
    }, 100);
}

// Function to apply table filter
function applyTableFilter() {
    const filterValue = document.getElementById('table-filter').value;
    const table = document.getElementById('servers-table');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    let visibleCount = 0;

    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const status = parseInt(row.getAttribute('data-status'));
        const cpu = parseFloat(row.getAttribute('data-cpu'));
        const memory = parseFloat(row.getAttribute('data-memory'));
        const disk = parseFloat(row.getAttribute('data-disk'));

        let showRow = false;

        switch(filterValue) {
            case 'all':
                showRow = true;
                break;
            case 'critical':
                showRow = (status !== 1);
                break;
            case 'high_cpu':
                showRow = (cpu > 50);
                break;
            case 'high_memory':
                showRow = (memory > 80);
                break;
            case 'high_disk':
                showRow = (disk > 70);
                break;
        }

        if (showRow) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    }

    // Also apply search if there's a search term
    const searchTerm = document.getElementById('table-search').value;
    if (searchTerm) {
        searchTable();
    }
}

// Function to search table
function searchTable() {
    const input = document.getElementById('table-search');
    const filter = input.value.toLowerCase();
    const table = document.getElementById('servers-table');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        let found = false;

        for (let j = 0; j < cells.length; j++) {
            const cell = cells[j];
            if (cell.textContent.toLowerCase().indexOf(filter) > -1) {
                found = true;
                break;
            }
        }

        // Only show if it passes both search and filter
        if (found && row.style.display !== 'none') {
            row.style.display = '';
        } else if (!found) {
            row.style.display = 'none';
        }
    }
}

// Function to clear all filters
function clearFilters() {
    document.getElementById('table-search').value = '';
    document.getElementById('table-filter').value = 'all';
    applyTableFilter();
}

// Function to sort table
let sortDirection = {};
function sortTable(columnIndex) {
    const table = document.getElementById('servers-table');
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));

    // Toggle sort direction
    if (!sortDirection[columnIndex]) {
        sortDirection[columnIndex] = 'asc';
    } else {
        sortDirection[columnIndex] = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
    }

    rows.sort((a, b) => {
        let aValue = a.getElementsByTagName('td')[columnIndex].textContent.trim();
        let bValue = b.getElementsByTagName('td')[columnIndex].textContent.trim();

        // Try to parse as number
        const aNum = parseFloat(aValue.replace(/[^0-9.-]/g, ''));
        const bNum = parseFloat(bValue.replace(/[^0-9.-]/g, ''));

        if (!isNaN(aNum) && !isNaN(bNum)) {
            return sortDirection[columnIndex] === 'asc' ? aNum - bNum : bNum - aNum;
        }

        // String comparison
        if (sortDirection[columnIndex] === 'asc') {
            return aValue.localeCompare(bValue);
        } else {
            return bValue.localeCompare(aValue);
        }
    });

    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
}

// Function to update disk details visibility (if needed elsewhere in your code)
function updateDiskDetailsVisibility() {
    // Add your disk details logic here if needed
}
</script>

{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const servers = {{ servers | tojson }};
    if (!servers || servers.length === 0) return;

    // =================================================================
    // Chart 1: Server Resource Hotspot Analysis
    // =================================================================
    function createHotspotChart() {
        const online_servers = {
            x: [], y: [], text: [], customdata: [],
            mode: 'markers',
            name: 'Online',
            marker: {
                size: [],
                sizemin: 5,
                sizeref: 2,
                color: 'rgba(40, 167, 69, 0.7)',
                line: { color: 'rgba(40, 167, 69, 1)', width: 1 }
            }
        };

        const offline_servers = {
            x: [], y: [], text: [], customdata: [],
            mode: 'markers',
            name: 'Offline/Critical',
            marker: {
                size: [],
                sizemin: 5,
                sizeref: 2,
                color: 'rgba(220, 53, 69, 0.7)',
                line: { color: 'rgba(220, 53, 69, 1)', width: 1 }
            }
        };

        servers.forEach(s => {
            const target = s.Status === 1 ? online_servers : offline_servers;
            target.x.push(s.CPULoad);
            target.y.push(s.MemoryUsagePercent);
            target.text.push(s.NodeName);
            target.customdata.push([`IP: ${s.IPAddress}`, `OS: ${s.OperatingSystem}`]);
            target.marker.size.push(s.MaxDiskUsage > 0 ? s.MaxDiskUsage : 2);
        });

        online_servers.hovertemplate = offline_servers.hovertemplate =
            '<b>%{text}</b><br><br>' +
            'CPU Load: %{x:.1f}%<br>' +
            'Memory Usage: %{y:.1f}%<br>' +
            'Max Disk Usage: %{marker.size:.1f}%<br>' +
            '%{customdata[0]}<br>' +
            '%{customdata[1]}' +
            '<extra></extra>';

        const data = [online_servers, offline_servers];
        const layout = {
            title: { text: 'Server Resource Hotspot Analysis', font: { size: 20 } },
            xaxis: { title: 'CPU Load (%)', range: [0, 105], zeroline: false, gridcolor: '#e9ecef' },
            yaxis: { title: 'Memory Usage (%)', range: [0, 105], zeroline: false, gridcolor: '#e9ecef' },
            hovermode: 'closest',
            showlegend: true,
            legend: { orientation: 'h', yanchor: 'bottom', y: 1.02, xanchor: 'right', x: 1 },
            margin: { l: 60, r: 40, b: 60, t: 60 },
            paper_bgcolor: 'white',
            plot_bgcolor: '#f8f9fa',
            shapes: [{
                type: 'rect',
                xref: 'x',
                yref: 'y',
                x0: 80, y0: 80,
                x1: 105, y1: 105,
                fillcolor: 'rgba(220, 53, 69, 0.1)',
                line: { width: 0 }
            }],
            annotations: [{
                x: 92.5, y: 92.5,
                xref: 'x', yref: 'y',
                text: 'CRITICAL ZONE',
                showarrow: false,
                font: { color: 'rgba(220, 53, 69, 0.4)', size: 14 }
            }]
        };

        Plotly.newPlot('health-graph', data, layout, {responsive: true});
    }

    // =================================================================
    // Chart 2: Health Summary by Operating System
    // =================================================================
    function createOsSummaryChart() {
        const osSummary = {};

        servers.forEach(server => {
            const os = server.OperatingSystem;
            if (!osSummary[os]) {
                osSummary[os] = { online: 0, offline: 0 };
            }
            if (server.Status === 1) {
                osSummary[os].online++;
            } else {
                osSummary[os].offline++;
            }
        });

        const sortedOsNames = Object.keys(osSummary).sort();
        const onlineCounts = sortedOsNames.map(os => osSummary[os].online);
        const offlineCounts = sortedOsNames.map(os => osSummary[os].offline);

        const traceOnline = {
            x: sortedOsNames,
            y: onlineCounts,
            name: 'Online',
            type: 'bar',
            text: onlineCounts,
            textposition: 'auto',
            marker: { color: 'rgba(40, 167, 69, 0.8)' },
            hovertemplate: '<b>%{x}</b><br>Online: %{y}<extra></extra>'
        };

        const traceOffline = {
            x: sortedOsNames,
            y: offlineCounts,
            name: 'Offline',
            type: 'bar',
            text: offlineCounts,
            textposition: 'auto',
            marker: { color: 'rgba(220, 53, 69, 0.8)' },
            hovertemplate: '<b>%{x}</b><br>Offline: %{y}<extra></extra>'
        };

        const data = [traceOnline, traceOffline];
        const layout = {
            barmode: 'group',
            title: { text: 'Server Count by OS and Status', font: { size: 20 } },
            xaxis: { title: 'Operating System', tickangle: -25 },
            yaxis: { title: 'Number of Servers' },
            legend: { orientation: 'h', yanchor: 'bottom', y: 1.02, xanchor: 'right', x: 1 },
            margin: { l: 60, r: 40, b: 120, t: 60 },
            paper_bgcolor: 'white',
            plot_bgcolor: '#f8f9fa'
        };

        Plotly.newPlot('os-summary-graph', data, layout, {responsive: true});
    }

    createHotspotChart();
    createOsSummaryChart();
});
</script>
{% endblock %}